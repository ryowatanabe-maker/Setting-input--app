import streamlit as st
import pandas as pd
import io

# --- å®šæ•°è¨­å®š ---
# ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—ã®é¸æŠè‚¢ã¨ãã‚Œã«å¯¾å¿œã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«æ•°/ã‚¿ã‚¤ãƒ—
GROUP_TYPES = {
    "èª¿å…‰": "1ch",
    "èª¿å…‰èª¿è‰²": "2ch",
    "Synca": "3ch",
    "Synca Bright": "fresh 3ch"
}
# CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ3è¡Œç›®ã¾ã§ï¼‰
CSV_HEADER = [
    ["Zone_Name", "Zone_ID", "Fade", "", "Group_Name", "Group_ID", "Group_Type", "Zone_Name(Link)"],
    ["ã‚¾ãƒ¼ãƒ³å", "ã‚¾ãƒ¼ãƒ³ID", "ãƒ•ã‚§ãƒ¼ãƒ‰ç§’", "", "ã‚°ãƒ«ãƒ¼ãƒ—å", "ã‚°ãƒ«ãƒ¼ãƒ—ID", "ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—", "ç´ã¥ã‘ã‚‹ã‚¾ãƒ¼ãƒ³å"],
    ["A", "B", "C", "D", "E", "F", "G", "H"]
]

# --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

def create_initial_zone_data():
    """ã‚¾ãƒ¼ãƒ³æƒ…å ±ã®åˆæœŸDataFrameã‚’ä½œæˆ"""
    return pd.DataFrame({
        "ã‚¾ãƒ¼ãƒ³å": [""],
        "ã‚¾ãƒ¼ãƒ³ID": [4097],
        "ãƒ•ã‚§ãƒ¼ãƒ‰ç§’": [0],
        "": [""] # Dåˆ—ã¯åŒºåˆ‡ã‚Šã¨ã—ã¦ç©ºæ¬„
    })

def create_initial_group_data():
    """ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã®åˆæœŸDataFrameã‚’ä½œæˆ"""
    return pd.DataFrame({
        "ã‚°ãƒ«ãƒ¼ãƒ—å": [""],
        "ã‚°ãƒ«ãƒ¼ãƒ—ID": [32769],
        "ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—": [""],
        "ç´ã¥ã‘ã‚‹ã‚¾ãƒ¼ãƒ³å": [""]
    })

def create_csv_output(shop_name, zone_df, group_df):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¨ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‹ã‚‰æœ€çµ‚çš„ãªCSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    - æ¡ä»¶â‘¡: å…¨ã¦ï¼£ï¼³ï¼¶ãƒ‡ãƒ¼ã‚¿ã®4è¡Œç›®ã‹ã‚‰è¨˜å…¥ã•ã‚Œã‚‹ã‚ˆã†ã«å¯¾å¿œ
    """
    
    # ã‚¾ãƒ¼ãƒ³IDã¨ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’æ›´æ–°ï¼ˆIDãŒé€£ç•ªã«ãªã‚‹ã‚ˆã†ã«ï¼‰
    # zone_df.indexã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚ã€IDã¯ãƒ™ãƒ¼ã‚¹ID + index
    zone_df_processed = zone_df.copy()
    group_df_processed = group_df.copy()
    
    zone_df_processed["ã‚¾ãƒ¼ãƒ³ID"] = 4097 + zone_df_processed.index
    group_df_processed["ã‚°ãƒ«ãƒ¼ãƒ—ID"] = 32769 + group_df_processed.index
    
    # ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—ã‹ã‚‰ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ã‚’å–å¾—
    group_df_processed["Group_Type"] = group_df_processed["ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—"].apply(lambda x: GROUP_TYPES.get(x, ""))
    
    # æœ€çµ‚çš„ãªDataFrameã®çµåˆ (å¹…ã‚’åˆã‚ã›ã‚‹)
    # ã‚¾ãƒ¼ãƒ³æƒ…å ±: A, B, C, Dåˆ—
    zone_data = zone_df_processed[["ã‚¾ãƒ¼ãƒ³å", "ã‚¾ãƒ¼ãƒ³ID", "ãƒ•ã‚§ãƒ¼ãƒ‰ç§’", ""]]
    zone_data.columns = ["A", "B", "C", "D"] # åˆ—åã‚’A, B, C, Dã«ä»®å¤‰æ›´
    
    # ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±: E, F, G, Håˆ—
    group_data = group_df_processed[["ã‚°ãƒ«ãƒ¼ãƒ—å", "ã‚°ãƒ«ãƒ¼ãƒ—ID", "Group_Type", "ç´ã¥ã‘ã‚‹ã‚¾ãƒ¼ãƒ³å"]]
    group_data.columns = ["E", "F", "G", "H"] # åˆ—åã‚’E, F, G, Hã«ä»®å¤‰æ›´

    # è¡Œæ•°ãŒå°‘ãªã„æ–¹ã«NaNã‚’è©°ã‚ã‚‹
    max_len = max(len(zone_data), len(group_data))
    
    # çµåˆç”¨ã«indexã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦é•·ã•ã‚’æƒãˆã‚‹
    zone_data_filled = pd.concat([zone_data, pd.DataFrame(index=range(max_len))]).iloc[:max_len].reset_index(drop=True)
    group_data_filled = pd.concat([group_data, pd.DataFrame(index=range(max_len))]).iloc[:max_len].reset_index(drop=True)
    
    # çµåˆ
    combined_df = pd.concat([zone_data_filled, group_data_filled], axis=1)

    # 4è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æº–å‚™
    data_lines = combined_df.rename(columns={"A": "Zone_Name", "B": "Zone_ID", "C": "Fade", "D": "", "E": "Group_Name", "F": "Group_ID", "G": "Group_Type", "H": "Zone_Name(Link)"})

    # ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
    header_df = pd.DataFrame(CSV_HEADER)
    # åˆ—æ•°ãŒä¸€è‡´ã™ã‚‹ã‚ˆã†ã«èª¿æ•´
    header_df.columns = data_lines.columns 
    
    final_df = pd.concat([header_df, data_lines], ignore_index=True)
    
    # CSVãƒ•ã‚¡ã‚¤ãƒ«å
    file_name = f"{shop_name}_setting_data.csv"
    
    # CSVæ–‡å­—åˆ—ã‚’ç”Ÿæˆ (BOMä»˜ãUTF-8ã§Excelã§ã®æ–‡å­—åŒ–ã‘ã‚’é˜²ã)
    csv_buffer = io.StringIO()
    # ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã™ã§ã«DataFrameã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€header=False
    final_df.to_csv(csv_buffer, index=False, header=False, encoding='utf-8-sig')
    
    return csv_buffer.getvalue(), file_name, final_df.iloc[3:] # 4è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã‚’è¿”ã™

# --- Streamlit UI ---

st.title("åº—èˆ—è¨­å®šãƒ‡ãƒ¼ã‚¿ä½œæˆã‚¢ãƒ—ãƒª âš™ï¸")

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ–
if 'zone_data' not in st.session_state:
    st.session_state.zone_data = create_initial_zone_data()
if 'group_data' not in st.session_state:
    st.session_state.group_data = create_initial_group_data()
if 'confirm_step' not in st.session_state:
    st.session_state.confirm_step = False

## â‘  åº—èˆ—åã‚’å…¥åŠ›
st.header("1. åº—èˆ—åå…¥åŠ›")
shop_name = st.text_input("åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå¿…é ˆï¼‰", key="shop_name_input")
output_filename = f"{shop_name}_setting_data.csv"

st.subheader("å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å: **`{}`**".format(output_filename if shop_name else "åº—èˆ—å_setting_data.csv"))

st.markdown("---")

## â‘¡ ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’å…¥åŠ›
st.header("2. ã‚¾ãƒ¼ãƒ³æƒ…å ±å…¥åŠ›")
st.caption("ğŸš¨ Båˆ—IDã¯è‡ªå‹•ã§é€£ç•ª(4097ã€œ)ã«ãªã‚Šã¾ã™ã€‚Cåˆ—ãƒ•ã‚§ãƒ¼ãƒ‰ç§’ã¯0ã€œ3599ç§’(59åˆ†59ç§’)ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚")

# ã‚¾ãƒ¼ãƒ³IDã®åˆ—è¨­å®š (è¡¨ç¤ºå°‚ç”¨/ç·¨é›†ä¸å¯)
zone_id_col = st.column_config.NumberColumn(
    "ã‚¾ãƒ¼ãƒ³ID (Båˆ—)",
    help="è‡ªå‹•ã§4097ã‹ã‚‰é€£ç•ªã«ãªã‚Šã¾ã™ã€‚",
    disabled=True,
    min_value=4097
)

# ãƒ•ã‚§ãƒ¼ãƒ‰ç§’ã®åˆ—è¨­å®š (0ã€œ3599ç§’ã®ç¯„å›²ã§åˆ¶é™)
fade_col = st.column_config.NumberColumn(
    "ãƒ•ã‚§ãƒ¼ãƒ‰ç§’ (Cåˆ—)",
    help="0ç§’ã€œ59åˆ†59ç§’ (3599ç§’) ã®é–“ã§è¨­å®šå¯èƒ½ã§ã™ã€‚",
    min_value=0,
    max_value=3599,
    step=1
)

# st.data_editorã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªè¡¨ã‚’ä½œæˆ (æ¡ä»¶â‘ : +ãƒœã‚¿ãƒ³ã§è¡Œã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«)
# ã‚¾ãƒ¼ãƒ³å (A4ä»¥é™), ãƒ•ã‚§ãƒ¼ãƒ‰ (C4ä»¥é™), ã‚¾ãƒ¼ãƒ³ID (B4ä»¥é™)
edited_zone_df = st.data_editor(
    st.session_state.zone_data,
    key="zone_editor",
    use_container_width=True,
    num_rows="dynamic", # æ¡ä»¶â‘ : +ãƒœã‚¿ãƒ³ã§è¡Œã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«
    column_config={
        "ã‚¾ãƒ¼ãƒ³å": st.column_config.TextColumn("ã‚¾ãƒ¼ãƒ³å (Aåˆ—)"),
        "ã‚¾ãƒ¼ãƒ³ID": zone_id_col,
        "ãƒ•ã‚§ãƒ¼ãƒ‰ç§’": fade_col,
        "": st.column_config.TextColumn("Dåˆ—ï¼ˆç©ºæ¬„ï¼‰", disabled=True)
    }
)

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°
st.session_state.zone_data = edited_zone_df

st.markdown("---")

## â‘¢ ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å…¥åŠ›
st.header("3. ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±å…¥åŠ›")
st.caption("ğŸš¨ Fåˆ—IDã¯è‡ªå‹•ã§é€£ç•ª(32769ã€œ)ã«ãªã‚Šã¾ã™ã€‚Gåˆ—ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—ã¯é¸æŠè‚¢ã«å¿œã˜ã¦IDãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™ã€‚")

# ã‚¾ãƒ¼ãƒ³åã®é¸æŠè‚¢ãƒªã‚¹ãƒˆã‚’ä½œæˆ
zone_names = [name for name in edited_zone_df["ã‚¾ãƒ¼ãƒ³å"].dropna().tolist() if name != ""]
zone_names.insert(0, "") # æœªè¨˜å…¥ã§ã‚‚å¯ã¨ã™ã‚‹ãŸã‚ã€ç©ºæ¬„ã‚’å…ˆé ­ã«è¿½åŠ 

# ã‚°ãƒ«ãƒ¼ãƒ—IDã®åˆ—è¨­å®š (è¡¨ç¤ºå°‚ç”¨/ç·¨é›†ä¸å¯)
group_id_col = st.column_config.NumberColumn(
    "ã‚°ãƒ«ãƒ¼ãƒ—ID (Fåˆ—)",
    help="è‡ªå‹•ã§32769ã‹ã‚‰é€£ç•ªã«ãªã‚Šã¾ã™ã€‚",
    disabled=True,
    min_value=32769
)

# ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—ã®åˆ—è¨­å®š (ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§4ã¤ã‹ã‚‰é¸ã¶)
group_type_col = st.column_config.SelectboxColumn(
    "ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ— (Gåˆ—)",
    help="é¸æŠè‚¢ã«å¿œã˜ã¦ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±(1ch, 2ch, 3ch, fresh 3ch)ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚",
    options=list(GROUP_TYPES.keys())
)

# ç´ã¥ã‘ã‚‹ã‚¾ãƒ¼ãƒ³åã®åˆ—è¨­å®š (ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§ã‚¾ãƒ¼ãƒ³åã‚’é¸æŠ)
link_zone_col = st.column_config.SelectboxColumn(
    "ç´ã¥ã‘ã‚‹ã‚¾ãƒ¼ãƒ³å (Håˆ—)",
    help="2.ã§å…¥åŠ›ã—ãŸã‚¾ãƒ¼ãƒ³åã‹ã‚‰é¸æŠã—ã¾ã™ã€‚",
    options=zone_names
)

# st.data_editorã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªè¡¨ã‚’ä½œæˆ
# ã‚°ãƒ«ãƒ¼ãƒ—å (E4ä»¥é™), ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ— (G4ä»¥é™), ç´ã¥ã‘ã‚‹ã‚¾ãƒ¼ãƒ³å (H4ä»¥é™), ã‚°ãƒ«ãƒ¼ãƒ—ID (F4ä»¥é™)
edited_group_df = st.data_editor(
    st.session_state.group_data,
    key="group_editor",
    use_container_width=True,
    num_rows="dynamic", # æ¡ä»¶â‘ : +ãƒœã‚¿ãƒ³ã§è¡Œã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«
    column_config={
        "ã‚°ãƒ«ãƒ¼ãƒ—å": st.column_config.TextColumn("ã‚°ãƒ«ãƒ¼ãƒ—å (Eåˆ—)"),
        "ã‚°ãƒ«ãƒ¼ãƒ—ID": group_id_col,
        "ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—": group_type_col,
        "ç´ã¥ã‘ã‚‹ã‚¾ãƒ¼ãƒ³å": link_zone_col
    }
)

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°
st.session_state.group_data = edited_group_df

st.markdown("---")

## å‡¦ç†å®Ÿè¡Œãƒœã‚¿ãƒ³
if st.button("è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ç”¨ã«æº–å‚™", type="primary"):
    if not shop_name:
        st.error("ğŸš¨ **åº—èˆ—å**ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        st.session_state.csv_data, st.session_state.file_name, st.session_state.preview_df = create_csv_output(
            shop_name,
            edited_zone_df.dropna(how='all').reset_index(drop=True), # å…¨ã¦NaNã®è¡Œã‚’å‰Šé™¤ã—ã¦indexã‚’ãƒªã‚»ãƒƒãƒˆ
            edited_group_df.dropna(how='all').reset_index(drop=True)
        )
        st.session_state.confirm_step = True
        st.success("å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚æœ€çµ‚ç¢ºèªã«é€²ã‚“ã§ãã ã•ã„ã€‚")

st.markdown("---")

## â‘¢ æœ€å¾Œã«ã“ã‚Œã§åˆã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰å‡ºåŠ›
if st.session_state.confirm_step:
    st.header("4. æœ€çµ‚ç¢ºèªã¨å‡ºåŠ› (æ¡ä»¶â‘¢)")
    
    st.subheader(f"âœ… å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å: **`{st.session_state.file_name}`**")

    st.warning("âš ï¸ **4è¡Œç›®ä»¥é™**ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã«è¨˜å…¥ã•ã‚Œã‚‹éƒ¨åˆ†ï¼‰ã‚’æœ€çµ‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    
    # 4è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã‚’è¡¨ç¤º
    st.dataframe(
        st.session_state.preview_df, 
        use_container_width=True, 
        hide_index=True
    )

    st.download_button(
        label="ğŸ“¥ ç¢ºèªOKï¼ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        data=st.session_state.csv_data,
        file_name=st.session_state.file_name,
        mime='text/csv'
    )